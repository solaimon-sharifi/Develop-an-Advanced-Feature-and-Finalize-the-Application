{% extends "layout.html" %}

{% block title %}Register{% endblock %}

{% block content %}
<div class="auth-shell">
  <div class="glass-panel max-w-2xl w-full space-y-8">
    <div class="space-y-2">
      <p class="text-xs uppercase tracking-[0.55em] text-red-300">Valorant Coach</p>
      <h1 class="text-3xl font-black">Secure your squad room</h1>
      <p class="dashboard-note">
        Create a protected account, begin logging matches, and unlock the Raider dashboard.
      </p>
    </div>

    <form id="registerForm" class="space-y-5">
      <div>
        <label class="form-label" for="username">Username</label>
        <input id="username" name="username" required class="form-input" />
      </div>

      <div>
        <label class="form-label" for="email">Email</label>
        <input id="email" name="email" type="email" required class="form-input" />
      </div>

      <div>
        <label class="form-label" for="password">Password</label>
        <input id="password" name="password" type="password" required class="form-input" />
      </div>

      <div>
        <label class="form-label" for="confirm">Confirm Password</label>
        <input id="confirm" name="confirm_password" type="password" required class="form-input" />
      </div>

      <div>
        <label class="form-label" for="notes">Agent alias</label>
        <input id="notes" name="notes" placeholder="Optional call-sign" class="form-input" />
      </div>

      <button type="submit" class="w-full btn-primary">Create account</button>
    </form>

    <div class="text-center text-sm text-gray-400">
      Already locked in? <a href="{{ url_for('login_page') }}" class="text-red-200 hover:text-white">Sign in</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('registerForm');
  if (!form) return;

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Creating account...';
    submitBtn.disabled = true;

    const payload = {
      username: form.username.value.trim(),
      email: form.email.value.trim(),
      password: form.password.value,
    };

    if (!payload.username || !payload.email || !payload.password) {
      showToast('Fill every field to continue', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      return;
    }

    if (payload.password !== form.confirm_password.value) {
      showToast('Passwords do not match', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      return;
    }

    try {
      const response = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const result = await response.json();
      if (!response.ok) {
        throw new Error(result.detail || 'Unable to create account');
      }

      showToast('Account created! Redirecting to login...', 'success');
      setTimeout(() => window.location.assign("{{ url_for('login_page') }}"), 800);
    } catch (error) {
      showToast(error.message, 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
});
</script>
{% endblock %}
