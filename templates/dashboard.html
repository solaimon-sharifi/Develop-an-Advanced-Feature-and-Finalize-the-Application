{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<section class="dashboard-grid">
  <article class="dashboard-panel">
    <div class="panel-heading">
      <h2>Valorant Coach</h2>
      <span id="matchCount" class="stat-chip">0 Matches</span>
    </div>
    <div class="profile-meta">
      <p class="text-2xl font-bold" id="dashboardUsername">Loading...</p>
      <p class="dashboard-note" id="dashboardEmail">Checking player database...</p>
    </div>
    <p class="dashboard-note" id="dashboardNotice"></p>
  </article>

  <article class="dashboard-panel">
    <div class="panel-heading">
      <h2>Recent matches</h2>
      <button id="refreshMatches" class="btn-secondary text-xs">Refresh</button>
    </div>
    <div id="matchList" class="match-list">
      <div class="empty-state">No matches logged yet. Add one from the form.</div>
    </div>
  </article>

  <article class="dashboard-panel">
    <div class="panel-heading">
      <h2>Saved strategies</h2>
    </div>
    <div id="strategyList" class="strategy-list">
      <div class="empty-state">No strategies yet.</div>
    </div>
  </article>

  <article class="dashboard-panel">
    <div class="panel-heading">
      <h2>Log a match</h2>
    </div>
    <form id="matchForm" class="match-form">
      <div>
        <label for="map">Map</label>
        <input id="map" name="map" class="form-input" required placeholder="Bind" />
      </div>
      <div>
        <label for="agent">Agent</label>
        <input id="agent" name="agent" class="form-input" required placeholder="Sova" />
      </div>
      <div>
        <label for="score">Score</label>
        <input id="score" name="score" type="number" min="0" max="10" step="1" class="form-input" value="0" required />
      </div>
      <div>
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" class="form-textarea" placeholder="Half-time adjustments or clutch moments"></textarea>
      </div>
      <button type="submit" class="w-full btn-primary">Save match</button>
    </form>
  </article>
</section>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const token = localStorage.getItem('access_token');
  if (!token) {
    return window.location.assign("{{ url_for('login_page') }}");
  }

  const authHeaders = {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/json',
  };

  const usernameEl = document.getElementById('dashboardUsername');
  const emailEl = document.getElementById('dashboardEmail');
  const noticeEl = document.getElementById('dashboardNotice');
  const matchCountEl = document.getElementById('matchCount');
  const matchListEl = document.getElementById('matchList');
  const strategyListEl = document.getElementById('strategyList');
  const matchForm = document.getElementById('matchForm');
  const refreshButton = document.getElementById('refreshMatches');

  let matches = [];
  let strategies = [];

  const renderMatches = () => {
    matchCountEl.textContent = `${matches.length} match${matches.length === 1 ? '' : 'es'}`;
    matchListEl.innerHTML = '';

    if (!matches.length) {
      matchListEl.innerHTML = '<div class="empty-state">No matches logged yet. Use the form to add one.</div>';
      return;
    }

    matches.forEach((match) => {
      const created = new Date(match.created_at).toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
      });

      const card = document.createElement('div');
      card.className = 'match-card';
      card.innerHTML = `
        <div class="heading">
          <span class="text-sm uppercase tracking-[0.4em] text-gray-400">${match.map}</span>
          <span class="match-score">${match.score}</span>
        </div>
        <div class="match-meta">
          <span>Agent: ${match.agent}</span>
          <span>${created}</span>
        </div>
        <p class="match-notes">${match.notes ? match.notes : 'No notes yet.'}</p>
      `;

      matchListEl.appendChild(card);
    });
  };

  const renderStrategies = () => {
    strategyListEl.innerHTML = '';
    if (!strategies.length) {
      strategyListEl.innerHTML = '<div class="empty-state">No strategies saved yet.</div>';
      return;
    }

    strategies.forEach((strategy) => {
      const card = document.createElement('div');
      card.className = 'strategy-card';
      card.innerHTML = `
        <div class="match-meta">
          <span class="text-sm uppercase tracking-[0.4em] text-gray-400">${strategy.title}</span>
          <span class="match-score">${new Date(strategy.created_at).toLocaleDateString()}</span>
        </div>
        <p class="strategy-description">${strategy.description || 'No description provided.'}</p>
      `;
      strategyListEl.appendChild(card);
    });
  };

  const loadDashboard = async () => {
    try {
      const response = await fetch('/dashboard', { headers: authHeaders });
      if (!response.ok) {
        throw new Error('Unable to load dashboard');
      }

      const data = await response.json();
      usernameEl.textContent = data.user.username;
      emailEl.textContent = data.user.email;
      noticeEl.textContent = `Last synced: ${new Date().toLocaleTimeString()}`;
      matches = data.matches;
      strategies = data.strategies;
      renderMatches();
      renderStrategies();
    } catch (error) {
      showToast(error.message || 'Unable to load dashboard', 'error');
      if (error.message.toLowerCase().includes('unauthorized')) {
        localStorage.clear();
        window.location.assign("{{ url_for('login_page') }}");
      }
    }
  };

  matchForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const submitBtn = matchForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Logging match...';
    submitBtn.disabled = true;

    const payload = {
      map: matchForm.map.value.trim(),
      agent: matchForm.agent.value.trim(),
      score: Number(matchForm.score.value),
      notes: matchForm.notes.value.trim(),
    };

    try {
      const response = await fetch('/matches', {
        method: 'POST',
        headers: authHeaders,
        body: JSON.stringify(payload),
      });

      const result = await response.json();
      if (!response.ok) {
        throw new Error(result.detail || 'Unable to save match');
      }

      matches = [result, ...matches];
      renderMatches();
      matchForm.reset();
      showToast('Match logged!', 'success');
    } catch (error) {
      showToast(error.message || 'Unable to save match', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  refreshButton.addEventListener('click', loadDashboard);

  loadDashboard();
})();
</script>
{% endblock %}
