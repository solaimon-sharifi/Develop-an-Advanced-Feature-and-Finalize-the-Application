{% extends "layout.html" %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="auth-shell">
  <div class="glass-panel max-w-md w-full space-y-8">
    <div class="space-y-2">
      <p class="text-xs uppercase tracking-[0.55em] text-red-300">Valorant Coach</p>
      <h1 class="text-3xl font-black">Return to the lineup</h1>
      <p class="dashboard-note">
        Sign in to review your matches, strategize with teammates, and keep every agent detail locked in the dashboard.
      </p>
    </div>

    <form id="loginForm" class="space-y-6">
      <div>
        <label class="form-label" for="username">Username</label>
        <input
          id="username"
          name="username"
          autocomplete="username"
          required
          class="form-input"
        />
      </div>

      <div>
        <label class="form-label" for="password">Password</label>
        <input
          id="password"
          type="password"
          name="password"
          autocomplete="current-password"
          required
          class="form-input"
        />
      </div>

      <div class="flex items-center justify-between text-xs text-gray-400">
        <label class="flex items-center gap-2">
          <input type="checkbox" id="remember" class="h-4 w-4 rounded border-white/20 bg-black/60" />
          Remember me
        </label>
        <a href="#" class="text-red-300 hover:text-red-200">Need help?</a>
      </div>

      <button type="submit" class="w-full btn-primary">Sign in</button>
    </form>

    <div class="text-center text-sm text-gray-400">
      New here? <a href="{{ url_for('register_page') }}" class="text-red-200 hover:text-white">Create an account</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('loginForm');
  const rememberInput = document.getElementById('remember');

  if (localStorage.getItem('remember_login') === 'true') {
    const remembered = localStorage.getItem('remembered_username');
    if (remembered) {
      form.username.value = remembered;
      rememberInput.checked = true;
    }
  }

  form.addEventListener('submit', async function (event) {
    event.preventDefault();
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Signing in...';
    submitBtn.disabled = true;

    try {
      const response = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: form.username.value.trim(),
          password: form.password.value,
        }),
      });

      const payload = await response.json();
      if (!response.ok) {
        throw new Error(payload.detail || 'Login failed');
      }

      localStorage.setItem('access_token', payload.access_token);
      localStorage.setItem('refresh_token', payload.refresh_token);
      localStorage.setItem('token_expires', payload.expires_at);
      localStorage.setItem('user_id', payload.user_id);
      localStorage.setItem('username', payload.username);

      if (rememberInput.checked) {
        localStorage.setItem('remember_login', 'true');
        localStorage.setItem('remembered_username', form.username.value.trim());
      } else {
        localStorage.removeItem('remember_login');
        localStorage.removeItem('remembered_username');
      }

      showToast('Welcome back, ' + payload.username + '!', 'success');
      setTimeout(() => window.location.assign("{{ url_for('dashboard_view') }}"), 500);
    } catch (error) {
      showToast(error.message || 'Unable to sign in', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
});
</script>
{% endblock %}
